<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulação de Sistema de Fila M/M/1</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f5fffa;
        }
        table {
            background-color: #f0f8ff;
        }
    </style>
</head>
<body>
    <div class="container my-5">
        <h1 class="text-center">Simulação de Sistema de Fila M/M/1</h1>
        <hr>
        <form id="simulationForm" class="mb-4">
            <div class="row mb-3">
                <div class="col-md-6">
                    <label for="lambda" class="form-label">Taxa de Chegada (&lambda;)</label>
                    <input type="number" class="form-control" id="lambda" value="32500" required>
                </div>
                <div class="col-md-6">
                    <label for="mu" class="form-label">Taxa de Serviço (&mu;)</label>
                    <input type="number" class="form-control" id="mu" value="22500" required>
                </div>
            </div>
            <div class="mb-3">
                <label for="numPackages" class="form-label">Número de Pacotes (N)</label>
                <input type="number" class="form-control" id="numPackages" value="5000" required>
            </div>
            <button type="submit" class="btn btn-primary">Iniciar Simulação</button>
        </form>

        <div id="results" class="d-none">
            <h2>Resultados</h2>
            <table class="table table-bordered">
                <thead>
                    <tr>
                        <th>&lambda;</th>
                        <th>&mu;</th>
                        <th>N</th>
                        <th>T</th>
                        <th>E[tsf]</th>
                        <th>E[nf]</th>
                        <th>D[tsf]</th>
                        <th>D[nf]</th>
                        <th>U</th>
                    </tr>
                </thead>
                <tbody id="resultsBody"></tbody>
            </table>
        </div>
    </div>

    <script>
        class Pacote {
            constructor(ic = 0, cpf = 0, eps = 0, sps = 0, nf = 0) {
                this.ic = ic;
                this.cpf = cpf;
                this.eps = eps;
                this.sps = sps;
                this.nf = nf;
            }
        }

        class SimuladorFila {
            constructor() {
                this.lambda = 0;
                this.mu = 0;
                this.pacotes = [];
            }

            iniciar(lambda, mu) {
                this.lambda = lambda;
                this.mu = mu;
                this.pacotes = [new Pacote()];
            }

            gerarTempoExp(taxa) {
                const u = Math.random();
                return -Math.log(1 - u) / taxa;
            }

            empacotar() {
                const ultimo = this.pacotes[this.pacotes.length - 1];
                const novo = new Pacote();

                novo.ic = this.gerarTempoExp(this.lambda);
                novo.cpf = novo.ic + ultimo.cpf;
                novo.eps = Math.max(novo.cpf, ultimo.sps);
                novo.sps = novo.eps + this.gerarTempoExp(this.mu);
                novo.nf = 0;

                this.pacotes.push(novo);
            }

            simular(numPacotes) {
                for (let i = 1; i < numPacotes; i++) {
                    this.empacotar();
                    this.calcularNf(i);
                }
            }

            calcularNf(indice) {
                this.pacotes[indice].nf = 0;
                for (let i = indice - 1; i >= 0; i--) {
                    if (this.pacotes[indice].cpf < this.pacotes[i].eps) {
                        this.pacotes[indice].nf++;
                    } else {
                        break;
                    }
                }
            }

            estatisticas() {
                const n = this.pacotes.length;
                let T = this.pacotes[n - 1].sps - this.pacotes[0].eps;
                let utilizacao = 0;
                let somaTs = 0, somaTsf = 0, somaNf = 0;
                let somaTs2 = 0, somaTsf2 = 0, somaNf2 = 0;

                this.pacotes.forEach(p => {
                    const ts = p.sps - p.eps;
                    const tsf = p.sps - p.cpf;

                    somaTs += ts;
                    somaTsf += tsf;
                    somaNf += p.nf;

                    somaTs2 += ts * ts;
                    somaTsf2 += tsf * tsf;
                    somaNf2 += p.nf * p.nf;
                });

                utilizacao = somaTs / T;

                const mediaTsf = somaTsf / n;
                const mediaNf = somaNf / n;

                const desvioTsf = Math.sqrt(somaTsf2 / n - mediaTsf ** 2);
                const desvioNf = Math.sqrt(somaNf2 / n - mediaNf ** 2);

                return { T, utilizacao, mediaTsf, mediaNf, desvioTsf, desvioNf };
            }
        }

        document.getElementById("simulationForm").addEventListener("submit", function (e) {
            e.preventDefault();

            const lambda = parseFloat(document.getElementById("lambda").value);
            const mu = parseFloat(document.getElementById("mu").value);
            const numPackages = parseInt(document.getElementById("numPackages").value);

            const simulador = new SimuladorFila();
            simulador.iniciar(lambda, mu);
            simulador.simular(numPackages);

            const { T, utilizacao, mediaTsf, mediaNf, desvioTsf, desvioNf } = simulador.estatisticas();

            const resultsBody = document.getElementById("resultsBody");
            resultsBody.innerHTML = `
                <tr>
                    <td>${lambda}</td>
                    <td>${mu}</td>
                    <td>${numPackages}</td>
                    <td>${T.toFixed(5)}</td>
                    <td>${mediaTsf.toFixed(5)}</td>
                    <td>${mediaNf.toFixed(5)}</td>
                    <td>${desvioTsf.toFixed(5)}</td>
                    <td>${desvioNf.toFixed(5)}</td>
                    <td>${utilizacao.toFixed(5)}</td>
                </tr>
            `;

            document.getElementById("results").classList.remove("d-none");
        });
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
